<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>æ•¸æ“šè¼¸å…¥</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --fz: clamp(20px, 3vh, 26px);
      --fz-sm: clamp(18px, 2.5vh, 22px);
      --gap: 14px;
      --btn-pad: 20px;
      --radius: 14px;
    }
    html,body{margin:0;padding:0;background:#f6f8fb;color:#111;font-size:var(--fz);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans TC','PingFang TC',sans-serif;}
    .wrap{max-width:720px;margin:0 auto;padding:16px;}
    .tabs{display:flex;gap:8px;margin-bottom:10px;position:sticky;top:0;background:#f6f8fb;padding-top:6px;z-index:10}
    .tab{flex:1;text-align:center;padding:12px;border-radius:12px;border:2px solid #d9e1f2;background:#fff;font-weight:700;font-size:var(--fz)}
    .tab.active{background:#2f6fed;color:#fff;border-color:#2f6fed}
    .card{background:#fff;border-radius:16px;border:1px solid #e6ecf7;padding:18px;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
    .title{font-weight:800;margin-bottom:8px}
    .hint{color:#6b7280;font-size:var(--fz-sm);margin:4px 0 12px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .btn{display:inline-block;border:2px solid #2f6fed;background:#2f6fed;color:#fff;border-radius:14px;padding:var(--btn-pad);text-align:center;font-weight:700;font-size:1.1em}
    .btn.ghost{background:#fff;color:#2f6fed}
    .row{display:flex;gap:12px;align-items:center;margin:8px 0}
    input,select,textarea{width:100%;font-size:var(--fz);padding:14px;border-radius:10px;border:1px solid #c9d4ee;background:#fff}
    textarea{min-height:54px}
    .actions{position:sticky;bottom:0;background:#f6f8fb;padding:12px 0;margin-top:12px;display:flex;gap:12px}
    .actions .btn{flex:1;text-align:center}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-size:var(--fz-sm);opacity:0;transition:.25s}
    .toast.show{opacity:1}
    #debug{background:#ffeeba;color:#333;font-size:14px;padding:6px 10px;margin-bottom:10px;border-radius:8px;white-space:pre-line}
  </style>
</head>
<body>
<div class="wrap">
  <!-- Debugï¼ˆéœ€è¦æ™‚æœƒé¡¯ç¤ºç‹€æ…‹ï¼›ä¸ç”¨ç®¡å®ƒï¼‰ -->
  <div id="debug" hidden></div>

  <div class="tabs">
    <button class="tab active" data-pane="pane-bp">è¡€å£“</button>
    <button class="tab" data-pane="pane-glu">è¡€ç³–</button>
    <button class="tab" data-pane="pane-more">å…¶ä»–</button>
    <button class="tab" data-pane="pane-queue">æ¸…å–®</button>
  </div>

  <!-- å…±ç”¨ï¼šæ™‚é–“èˆ‡å‚™è¨» -->
  <div class="card">
    <div class="title">æ™‚é–“èˆ‡å‚™è¨»ï¼ˆå¯é¸ï¼‰</div>
    <div class="row">
      <input id="when" type="datetime-local">
      <input id="note" placeholder="å‚™è¨»ï¼ˆé¸å¡«ï¼‰">
    </div>
    <div class="hint">æœªé¸æ™‚é–“å‰‡é è¨­ç‚ºç¾åœ¨ã€‚</div>
  </div>

  <!-- è¡€å£“ -->
  <div id="pane-bp" class="pane card">
    <div class="title">è¡€å£“ï¼ˆmmHgï¼‰</div>
    <div class="hint">å…ˆé¸æ”¶ç¸®å£“ï¼Œå†é¸èˆ’å¼µå£“ï¼›æˆ–è¼¸å…¥è‡ªè¨‚æ•¸å­—ã€‚</div>
    <div class="row">
      <select id="bpSys"></select>
      <select id="bpDia"></select>
    </div>
    <div class="row">
      <input id="bpSysManual" inputmode="numeric" pattern="[0-9]*" placeholder="è‡ªè¨‚æ”¶ç¸®å£“">
      <input id="bpDiaManual" inputmode="numeric" pattern="[0-9]*" placeholder="è‡ªè¨‚èˆ’å¼µå£“">
    </div>
    <div class="row">
      <button class="btn" id="btnAddBp">åŠ å…¥æ¸…å–®ï¼šè¡€å£“</button>
    </div>
  </div>

  <!-- è¡€ç³– -->
  <div id="pane-glu" class="pane card" hidden>
    <div class="title">è¡€ç³–ï¼ˆmg/dLï¼‰</div>
    <div class="hint">é¸æ“‡æ™‚æ®µèˆ‡ç¯„åœï¼›æˆ–è‡ªè¨‚æ•¸å­—ã€‚</div>
    <div class="row">
      <select id="gluCtx">
        <option value="ç©ºè…¹">ç©ºè…¹</option>
        <option value="é£¯å¾Œ">é£¯å¾Œ</option>
      </select>
      <select id="gluRange"></select>
    </div>
    <div class="row">
      <input id="gluManual" inputmode="numeric" pattern="[0-9]*" placeholder="è‡ªè¨‚æ•¸å­—ï¼ˆmg/dLï¼‰">
    </div>
    <div class="row">
      <button class="btn" id="btnAddGlu">åŠ å…¥æ¸…å–®ï¼šè¡€ç³–</button>
    </div>
  </div>

  <!-- å…¶ä»– -->
  <div id="pane-more" class="pane card" hidden>
    <div class="title">å…¶ä»–</div>
    <div class="grid" id="quickGrid"></div>
  </div>

  <!-- æ¸…å–® -->
  <div id="pane-queue" class="pane card" hidden>
    <div class="title">å¾…é€å‡ºæ¸…å–®</div>
    <div id="list"></div>
  </div>

  <div class="actions">
    <button class="btn ghost" id="btnClear">æ¸…ç©ºæ¸…å–®</button>
    <button class="btn" id="btnSubmit">é€å‡ºå…¨éƒ¨</button>
  </div>

  <div id="toast" class="toast">å·²åŠ å…¥</div>
</div>

<script>
/* ===== å¯èª¿æ•´çš„ã€Œç¯„åœèˆ‡å¿«æ·ã€ ===== */
const CONFIG = {
  bpSys: ['90â€“109','110â€“119','120â€“129','130â€“139','140â€“159','â‰¥160'],
  bpDia: ['60â€“69','70â€“79','80â€“89','90â€“99','â‰¥100'],
  gluFPG: ['70â€“80','81â€“90','91â€“100','101â€“110','111â€“125','â‰¥126'],
  gluPPG: ['90â€“110','111â€“139','140â€“159','160â€“179','â‰¥180'],
  quickOthers: [
    { metric:'å¿ƒè·³', unit:'bpm',  choices:['60â€“70','71â€“80','81â€“90','91â€“100','101â€“110','â‰¥111'] },
    { metric:'é«”é‡', unit:'kg',   choices:['45â€“55','56â€“60','61â€“65','66â€“70','71â€“75','76â€“80','81â€“85','86â€“90','â‰¥91'] },
    { metric:'é«”è„‚', unit:'%',    choices:['18â€“20','21â€“23','24â€“26','27â€“29','30â€“32','33â€“35','â‰¥36'] },
    { metric:'å–æ°´', unit:'ml',   choices:[200,500,1000,1500,2000,2500,'â‰¥3000'] },
    { metric:'é‹å‹•', unit:'min',  choices:[10,20,30,45,60,90,'â‰¥91'] },
    { metric:'ç¡çœ ', unit:'/10',  choices:[1,2,3,4,5,6,7,8,9,10] }  // ç¡çœ å“è³ª 1~10
  ]
};

/* ===== å°å·¥å…· ===== */
const $ = s => document.querySelector(s);
const dbg = t => { const el = $('#debug'); if (!el) return; el.hidden = false; el.textContent = String(t); };
const toast = t => { const el=$('#toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1200); };
function fillSelect(sel, arr){ sel.innerHTML = arr.map(v=>`<option>${v}</option>`).join(''); }
function midFromRange(label){
  if (typeof label === 'number') return label;
  label = String(label||'');
  if(label.startsWith('â‰¥')) return Number(label.replace(/[^\d]/g,'')) + 5;
  if(label.includes('â€“')){ const [a,b]=label.split('â€“').map(n=>Number(n)); return Math.round((a+b)/2); }
  return Number(label.replace(/[^\d]/g,'')) || 0;
}
function basePostUrl(){ return location.href.replace(/\?.*$/, ''); }

/* ===== è³‡æ–™æš«å­˜æ¸…å–® ===== */
const queue = [];
function addItem(item){ queue.push(item); renderList(); toast('å·²åŠ å…¥æ¸…å–®'); }
function renderList(){
  const box = $('#list');
  if (!queue.length){ box.innerHTML='<div class="hint">ç›®å‰æ²’æœ‰å¾…é€å‡ºçš„è³‡æ–™ã€‚</div>'; return; }
  box.innerHTML = queue.map((it,i)=>`
    <div class="row" style="justify-content:space-between;border-bottom:1px dashed #e6ecf7;padding:10px 0;">
      <div>${it.metric}ï¼š<b>${it.value}</b> ${it.unit||''} ${it.ctx?`<span class="hint">(${it.ctx})</span>`:''}</div>
      <button class="btn ghost" onclick="queue.splice(${i},1);renderList()">ç§»é™¤</button>
    </div>`).join('');
}

/* ===== ç‰ˆé¢åˆå§‹åŒ– ===== */
function initTabs(){
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const pane = btn.dataset.pane;
      document.querySelectorAll('.pane').forEach(p=>p.hidden = (p.id !== pane));
    });
  });
}
function initBP(){
  fillSelect($('#bpSys'), CONFIG.bpSys);
  fillSelect($('#bpDia'), CONFIG.bpDia);
  $('#btnAddBp').addEventListener('click',()=>{
    const sys = $('#bpSysManual').value || $('#bpSys').value;
    const dia = $('#bpDiaManual').value || $('#bpDia').value;
    const sysVal = isNaN(Number(sys)) ? midFromRange(sys) : Number(sys);
    const diaVal = isNaN(Number(dia)) ? midFromRange(dia) : Number(dia);
    addItem({metric:'è¡€å£“', value:`${sysVal}/${diaVal}`, unit:'mmHg', note:$('#note').value, time:$('#when').value});
  });
}
function initGlu(){
  const ctxSel = $('#gluCtx'), rangeSel = $('#gluRange');
  const updateRanges = ()=> fillSelect(rangeSel, ctxSel.value==='ç©ºè…¹' ? CONFIG.gluFPG : CONFIG.gluPPG);
  ctxSel.addEventListener('change', updateRanges);
  updateRanges();
  $('#btnAddGlu').addEventListener('click',()=>{
    const ctx = ctxSel.value;
    let v = $('#gluManual').value;
    if (!v) v = midFromRange(rangeSel.value);
    addItem({metric: ctx==='ç©ºè…¹'?'ç©ºè…¹è¡€ç³–':'é£¯å¾Œè¡€ç³–', value:Number(v), unit:'mg/dL', ctx, note:$('#note').value, time:$('#when').value});
  });
}
function initOthers(){
  const grid = $('#quickGrid'); grid.innerHTML='';
  CONFIG.quickOthers.forEach(block=>{
    const wrap = document.createElement('div');
    wrap.className='card'; wrap.style.margin='0'; wrap.style.gridColumn='1/-1';
    const title = (block.metric === 'ç¡çœ ') ? 'ç¡çœ å“è³ªï¼ˆ1â€“10 åˆ†ï¼‰' : `${block.metric}ï¼ˆ${block.unit}ï¼‰`;
    wrap.innerHTML = `<div class="title">${title}</div><div class="grid"></div>`;
    const g = wrap.querySelector('.grid');
    block.choices.forEach(v=>{
      const b = document.createElement('button');
      b.className='btn ghost'; b.textContent = v + block.unit;
      b.addEventListener('click',()=> addItem({metric:block.metric, value:v, unit:block.unit, note:$('#note').value, time:$('#when').value}));
      g.appendChild(b);
    });
    grid.appendChild(wrap);
  });
}
/* ===== LIFFï¼ˆç©©å¥å–å¾— userIdï¼›è‡ªå‹•ç™»å…¥ï¼›ä¸‰ç¨®fallbackï¼›å«åµéŒ¯ï¼‰===== */
async function getUserIdSafely(){
  const LIFF_ID = '2008049339-GDpDJd3j';
  const d = (m)=>{
    const el = document.getElementById('debug');
    if (el){ el.hidden = false; el.textContent = String(m); }
    console.log('[LIFF]', m);
  };

  try{
    // initï¼ˆä¿ç•™ä½ åŸæœ¬çš„ timeout èˆ‡ external browser è¨­å®šï¼‰
    const initP = liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
    const timer = new Promise((_,rej)=> setTimeout(()=>rej(new Error('LIFF init timeout')), 6000));
    await Promise.race([initP, timer]);
    await (liff.ready || Promise.resolve());

    d(`isInClient=${liff.isInClient ? liff.isInClient() : 'n/a'}, isLoggedIn=${liff.isLoggedIn ? liff.isLoggedIn() : 'n/a'}`);

    // âœ… 1) å…ˆç”¨ getContextï¼ˆåœ¨ LINE App å…§æœ€ç©©ï¼‰
    try{
      const ctx = liff.getContext && liff.getContext();
      if (ctx && ctx.userId){ d('userId via getContext'); return ctx.userId; }
    }catch(e){ /* ignore */ }

    // âœ… 2) è‹¥ä¸åœ¨ App å…§ï¼Œå…ˆç¢ºä¿ç™»å…¥ï¼›æŒ‡å®š redirectUri å›åˆ°åŒä¸€é 
    if (typeof liff.isLoggedIn === 'function' && !liff.isLoggedIn()){
      d('å°šæœªç™»å…¥ â†’ liff.login() with redirectUri');
      const redirectUri = location.href.split('#')[0]; // å›åˆ°åŒä¸€é ï¼ˆå»æ‰ hashï¼‰
      liff.login({ redirectUri }); // scope ç”± Login Channel è¨­å®šï¼ˆéœ€å« openid, profileï¼‰
      return null; // login æœƒé‡æ–°è¼‰å…¥é é¢
    }
  
    // âœ… 3) å·²ç™»å…¥ï¼šgetProfileï¼ˆéœ€ Login Channel å‹¾é¸ profile scopeï¼‰
    try{
      const prof = await liff.getProfile();
      if (prof && prof.userId){ d('userId via getProfile'); return prof.userId; }
    }catch(e){ /* ignore */ }

    // âœ… 4) æœ€å¾Œå‚™æ´ï¼šID Tokenï¼ˆéœ€ openidï¼‰
    try{
      const idt = liff.getDecodedIDToken && liff.getDecodedIDToken();
      if (idt && idt.sub){ d('userId via decodedIDToken.sub'); return idt.sub; }
    }catch(e){ /* ignore */ }

    d('ä»æœªå–å¾— userIdï¼ˆä¸å½±éŸ¿å¯«å…¥ï¼‰');
    return null;

  }catch(e){
    d('LIFF å– userId å¤±æ•—ï¼ˆä¸å½±éŸ¿å¯«å…¥ï¼‰ï¼š' + (e.message || e));
    return null;
  }
}

function initSubmit(){
  $('#btnClear').addEventListener('click', ()=>{ queue.length = 0; renderList(); });
  $('#btnSubmit').addEventListener('click', async ()=>{
  if (!queue.length) return toast('æ¸…å–®æ˜¯ç©ºçš„');

  const userId = await getUserIdSafely(); // å¾ LIFF æŠ“ userId
  const payload = { source: 'LIFF', userId, items: queue }; // âœ… å…ˆå®£å‘Š payload

  dbg('ğŸ“¦ payload:\n' + JSON.stringify(payload, null, 2)); // âœ… å†å°å‡ºä¾†
  dbg('é€å‡ºå‰ userId = ' + userId);  // âœ… å° userId

  try {
    const res = await fetch('https://script.google.com/macros/s/AKfycbz2gRMRHwSbecpF5L95pdBdHqahNmx9wmCAItRW6GlTI-xRcXfzMRTGSqNAvgwjHoV9dA/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    if (json.status === 'OK'){
      toast('å·²é€å‡ºï¼'); queue.length = 0; renderList();
      try{ liff.closeWindow(); }catch(e){}
    } else {
      dbg('[ERR] ' + JSON.stringify(json));
      toast('é€å‡ºå¤±æ•—ï¼ˆé OKï¼‰');
    }
  } catch (err){
    dbg('[ERR] ' + (err.message || JSON.stringify(err)));
    toast('é€å‡ºå¤±æ•—');
  }
});

}

function boot(){ initTabs(); initBP(); initGlu(); initOthers(); initSubmit(); renderList(); }
document.addEventListener('DOMContentLoaded', boot);

// æŠŠ JS éŒ¯èª¤é¡¯ç¤ºåœ¨ç•«é¢é ‚ç«¯ï¼ˆæ–¹ä¾¿é™¤éŒ¯ï¼‰
window.addEventListener('error', e => dbg('[ERROR] ' + (e.message || e.toString())));
</script>
</body>
</html>

