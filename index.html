<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>數據輸入</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .btn { padding: 10px 20px; background: #2f6fed; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .btn.ghost { background: white; color: #2f6fed; border: 2px solid #2f6fed; }
    #debug { background: #ffeeba; padding: 10px; border-radius: 6px; margin-bottom: 12px; display: none; }
  </style>
</head>
<body>
  <div id="debug"></div>
  <h2>數據輸入</h2>
  <button class="btn" id="btnSubmit">送出數據</button>

  <script>
    const dbg = (t) => {
      const el = document.getElementById('debug');
      el.style.display = 'block';
      el.textContent = '[DEBUG] ' + t;
    };

    async function getUserIdSafely() {
      const LIFF_ID = '2008049339-GDpDJd3j';
      try {
        const initP = liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
        const timer = new Promise((_, rej) => setTimeout(() => rej(new Error('LIFF init timeout')), 6000));
        await Promise.race([initP, timer]);
        await (liff.ready || Promise.resolve());

        if (liff.getContext) {
          const ctx = liff.getContext();
          if (ctx && ctx.userId) {
            dbg('userId via getContext');
            return ctx.userId;
          }
        }

        if (!liff.isLoggedIn()) {
          dbg('尚未登入 → login');
          liff.login({ redirectUri: location.href.split('#')[0] });
          return null;
        }

        try {
          const prof = await liff.getProfile();
          if (prof && prof.userId) {
            dbg('userId via getProfile');
            return prof.userId;
          }
        } catch (e) {}

        try {
          const idt = liff.getDecodedIDToken();
          if (idt && idt.sub) {
            dbg('userId via decodedIDToken.sub');
            return idt.sub;
          }
        } catch (e) {}

        dbg('仍未取得 userId（不影響寫入）');
        return null;
      } catch (e) {
        dbg('LIFF init error: ' + e.message);
        return null;
      }
    }

    document.getElementById('btnSubmit').addEventListener('click', async () => {
      const userId = await getUserIdSafely();
      dbg('送出前 userId = ' + userId);
      const payload = {
        source: 'LIFF',
        userId,
        items: [
          {
            metric: '測試項目',
            value: '123',
            unit: 'mg/dL',
            note: '範例測試',
            time: new Date().toISOString()
          }
        ]
      };

      if (google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(res => {
            dbg('送出成功：' + JSON.stringify(res));
          })
          .withFailureHandler(err => {
            dbg('送出失敗：' + JSON.stringify(err));
          })
          .saveItemsFromClient(payload);
      } else {
        dbg('找不到 google.script.run，請確認是否由 GAS 頁面嵌入');
      }
    });
  </script>
</body>
</html>
