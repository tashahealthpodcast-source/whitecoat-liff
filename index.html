<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>健康數據紀錄</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 10px; }
    .pane { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
    .toast { background: #333; color:#fff; padding:5px; margin-top:10px; display:none; }
    #list, #debug { white-space: pre-wrap; border: 1px solid #ddd; padding: 10px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>健康數據紀錄</h1>

  <div class="pane" id="bp">
    <h2>血壓</h2>
    <input id="bp-sys" type="number" placeholder="收縮壓"> /
    <input id="bp-dia" type="number" placeholder="舒張壓">
    <button id="btn-bp">加入</button>
  </div>

  <div class="pane" id="glu">
    <h2>血糖</h2>
    <input id="glu-fpg" type="number" placeholder="空腹血糖">
    <button id="btn-fpg">加入</button><br>
    <input id="glu-ppg" type="number" placeholder="飯後血糖">
    <button id="btn-ppg">加入</button>
  </div>

  <div class="pane" id="others">
    <h2>其他</h2>
    <input id="hr" type="number" placeholder="心跳 bpm">
    <button id="btn-hr">加入</button><br>
    <input id="weight" type="number" placeholder="體重 kg">
    <button id="btn-weight">加入</button><br>
    <input id="fat" type="number" placeholder="體脂 %">
    <button id="btn-fat">加入</button><br>
    <input id="water" type="number" placeholder="喝水 ml">
    <button id="btn-water">加入</button><br>
    <input id="exer" type="number" placeholder="運動 分鐘">
    <button id="btn-exer">加入</button><br>
    <input id="sleep" type="number" placeholder="睡眠分數 1~10">
    <button id="btn-sleep">加入</button>
  </div>

  <h2>清單</h2>
  <div id="list"></div>
  <button id="btnClear">清空清單</button>
  <button id="btnSubmit">送出</button>

  <h2>Debug</h2>
  <div id="debug"></div>

<script>
const CONFIG = {
  bpSys: ['90-109','110-119','120-129','130-139','140-159','≥160'],
  bpDia: ['60-69','70-79','80-89','90-99','≥100'],
  gluFPG: ['70-80','81-90','91-100','101-110','111-125','≥126'],
  gluPPG: ['90-110','111-139','140-159','160-179','≥180'],
  quickOthers: [
    { metric:'心跳', unit:'bpm', choices:['60-70','71-80','81-90','91-100','101-110','≥111'] },
    { metric:'體重', unit:'kg', choices:['45-55','56-60','61-65','66-70','71-75','76-80','81-85','86-90','≥91'] },
    { metric:'體脂', unit:'%', choices:['18-20','21-23','24-26','27-29','30-32','33-35','≥36'] },
    { metric:'喝水', unit:'ml', choices:['200','500','1000','1500','2000','2500','≥3000'] },
    { metric:'運動', unit:'min', choices:['10','20','30','45','60','90','≥91'] },
    { metric:'睡眠', unit:'/10', choices:['1','2','3','4','5','6','7','8','9','10'] }
  ]
};

const queue = [];
function $(id){ return document.getElementById(id); }
function renderList(){ $('list').innerText = queue.map(x=>JSON.stringify(x)).join('\n'); }
function dbg(msg){ $('debug').innerText += msg + '\n'; }
function toast(msg){ alert(msg); }

// 加入資料
function initInputs(){
  $('btn-bp').onclick=()=>{ queue.push({metric:'血壓', value:$('bp-sys').value+'/'+$('bp-dia').value, unit:'mmHg'}); renderList(); };
  $('btn-fpg').onclick=()=>{ queue.push({metric:'空腹血糖', value:$('glu-fpg').value, unit:'mg/dL'}); renderList(); };
  $('btn-ppg').onclick=()=>{ queue.push({metric:'飯後血糖', value:$('glu-ppg').value, unit:'mg/dL'}); renderList(); };
  $('btn-hr').onclick =()=>{ queue.push({metric:'心跳', value:$('hr').value, unit:'bpm'}); renderList(); };
  $('btn-weight').onclick=()=>{ queue.push({metric:'體重', value:$('weight').value, unit:'kg'}); renderList(); };
  $('btn-fat').onclick=()=>{ queue.push({metric:'體脂', value:$('fat').value, unit:'%'}); renderList(); };
  $('btn-water').onclick=()=>{ queue.push({metric:'喝水', value:$('water').value, unit:'ml'}); renderList(); };
  $('btn-exer').onclick=()=>{ queue.push({metric:'運動', value:$('exer').value, unit:'min'}); renderList(); };
  $('btn-sleep').onclick=()=>{ queue.push({metric:'睡眠', value:$('sleep').value, unit:'/10'}); renderList(); };
}

// 送出
async function initSubmit(){
  $('btnClear').onclick=()=>{ queue.length=0; renderList(); };

  $('btnSubmit').onclick=async()=>{
    if(!queue.length) return toast('清單是空的');

    let userId=null, displayName='';
    try {
      const profile = await liff.getProfile();
      userId = profile.userId;
      displayName = profile.displayName;
    } catch(e){
      console.warn('getProfile error', e);
    }

    const payload={source:'LIFF', userId, displayName, items:queue};
    dbg('📦 Payload:\n'+JSON.stringify(payload,null,2));

    try{
      const res = await fetch("https://script.google.com/macros/s/AKfycbz2gRMRHwSbecpF5L95pdBdHqahNmx9wmCAItRW6GlTI-xRcXfzMRTGSqNAvgwjHoV9dA/exec",{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const txt = await res.text();
      dbg('伺服器回應: '+txt);
      queue.length=0; renderList();
      toast('✅ 已送出！');
    }catch(err){
      console.error('送出錯誤', err);
      dbg('Error: '+err);
      toast('❌ 送出失敗');
    }
  };
}

async function main(){
  await liff.init({ liffId:"2008049339-GDpDJd3j", withLoginOnExternalBrowser:true });
  if(!liff.isLoggedIn()){
    liff.login({ redirectUri: location.href.split('#')[0] });
  }
  boot();
}

function boot(){
  initInputs();
  initSubmit();
}

main();
</script>
</body>
</html>
